services:
  ui:
    build: ./services/ui
    container_name: origin-ui
    ports:
      - "8000:8000"
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CODEX_URL=http://codex:8000
      - MCP_HUB_URL=http://mcp-hub:8000
      - ORCHESTRATOR_URL=http://orchestrator:8000
    depends_on:
      - codex
      - mcp-hub
      - orchestrator
    restart: unless-stopped

  codex:
    build: ./services/codex
    container_name: origin-codex
    ports:
      - "8001:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - REQUIRE_AUTH=true
      - GOOGLE_SERVICE_ACCOUNT_EMAIL=${GOOGLE_SERVICE_ACCOUNT_EMAIL}
      - GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=${GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY}
    restart: unless-stopped

  mcp-hub:
    build: ./services/mcp-hub
    container_name: origin-mcp-hub
    ports:
      - "8002:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - CODEX_URL=http://codex:8000
      - CAD_URL=http://cad:8000
      - VAULT_URL=http://vault:8000
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - SEMRUSH_API_KEY=${SEMRUSH_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - FS_BASE_PATH=/data
      - MEMORY_PATH=/data/memory
    volumes:
      - mcp-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - codex
      - vault
    restart: unless-stopped

  cad:
    build: ./services/cad
    container_name: origin-cad
    ports:
      - "8003:8000"
    environment:
      - CAD_OUTPUT_DIR=/data/stl
    volumes:
      - cad-data:/data/stl
    restart: unless-stopped

  vault:
    build: ./services/vault
    container_name: origin-vault
    ports:
      - "8004:8000"
    environment:
      - VAULT_MASTER_KEY=${JWT_SECRET}
      - VAULT_DIR=/vault
    volumes:
      - vault-data:/vault
    restart: unless-stopped

  orchestrator:
    build: ./services/orchestrator
    container_name: origin-orchestrator
    ports:
      - "8005:8000"
    environment:
      - MCP_HUB_URL=http://mcp-hub:8000
      - CODEX_URL=http://codex:8000
      - VAULT_URL=http://vault:8000
      - CAD_URL=http://cad:8000
      - UI_URL=http://ui:8000
      - ORCHESTRATOR_DIR=/data/orchestrator
    volumes:
      - orchestrator-data:/data/orchestrator
    depends_on:
      - mcp-hub
      - vault
      - cad
    restart: unless-stopped

  backup:
    build: ./services/backup
    container_name: origin-backup
    ports:
      - "8006:8000"
    environment:
      - BACKUP_DIR=/backups
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_SCHEDULE=daily
      # Remote backup options: local, backblaze, dropbox, gdrive, rsync, external, s3
      - REMOTE_BACKUP_TYPE=${REMOTE_BACKUP_TYPE:-local}
      # Backblaze B2 (CHEAPEST - $0.005/GB/month)
      - B2_KEY_ID=${B2_KEY_ID:-}
      - B2_APP_KEY=${B2_APP_KEY:-}
      - B2_BUCKET_NAME=${B2_BUCKET_NAME:-}
      # Dropbox (FREE 2GB)
      - DROPBOX_ACCESS_TOKEN=${DROPBOX_ACCESS_TOKEN:-}
      - DROPBOX_PATH=${DROPBOX_PATH:-/origin-os-backups}
      # Google Drive (FREE 15GB)
      - GDRIVE_FOLDER_ID=${GDRIVE_FOLDER_ID:-}
      # Rsync to server (FREE)
      - RSYNC_DEST=${RSYNC_DEST:-}
      # External drive
      - EXTERNAL_BACKUP_PATH=${EXTERNAL_BACKUP_PATH:-}
      # Legacy S3 (expensive)
      - S3_BACKUP_ENABLED=${S3_BACKUP_ENABLED:-false}
      - S3_BACKUP_BUCKET=${S3_BACKUP_BUCKET:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-}
    volumes:
      - backup-data:/backups
      - /var/run/docker.sock:/var/run/docker.sock
      - ${EXTERNAL_BACKUP_PATH:-/tmp/no-external}:/mnt/external:rw
    restart: unless-stopped

volumes:
  mcp-data:
    name: origin-mcp-data
  cad-data:
    name: origin-cad-data
  vault-data:
    name: origin-vault-data
  orchestrator-data:
    name: origin-orchestrator-data
  backup-data:
    name: origin-backup-data

networks:
  default:
    name: origin-network
