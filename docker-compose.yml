services:
  ui:
    build: ./services/ui
    container_name: origin-ui
    ports:
      - "8080:8000"
    environment:
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - CODEX_URL=http://codex:8000
      - MCP_HUB_URL=http://mcp-hub:8000
      - ORCHESTRATOR_URL=http://orchestrator:8000
    depends_on:
      - codex
      - mcp-hub
      - orchestrator
    restart: unless-stopped

  codex:
    build: ./services/codex
    container_name: origin-codex
    ports:
      - "8001:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - REQUIRE_AUTH=true
      - GOOGLE_SERVICE_ACCOUNT_EMAIL=${GOOGLE_SERVICE_ACCOUNT_EMAIL}
      - GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY=${GOOGLE_SERVICE_ACCOUNT_PRIVATE_KEY}
      - SENTINEL_ALERTS_DIR=/vault/sentinel/alerts
    volumes:
      - sentinel-alerts:/vault/sentinel/alerts:ro
      - codex-rules:/codex/rules:ro
      - system-state:/system:ro
    restart: unless-stopped

  mcp-hub:
    build: ./services/mcp-hub
    container_name: origin-mcp-hub
    ports:
      - "8002:8000"
    environment:
      - JWT_SECRET=${JWT_SECRET}
      - CODEX_URL=http://codex:8000
      - CAD_URL=http://cad:8000
      - VAULT_URL=http://vault:8000
      - MEMORY_URL=http://memory:8000
      - AUTO_CLAUDE_URL=http://auto-claude:8000
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY}
      - SEMRUSH_API_KEY=${SEMRUSH_API_KEY}
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_REGION=${AWS_REGION}
      - FS_BASE_PATH=/data
      - MEMORY_PATH=/data/memory
    volumes:
      - mcp-data:/data
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - codex
      - vault
      - memory
      - auto-claude
    restart: unless-stopped

  cad:
    build: ./services/cad
    container_name: origin-cad
    ports:
      - "8003:8000"
    environment:
      - CAD_OUTPUT_DIR=/data/stl
    volumes:
      - cad-data:/data/stl
    restart: unless-stopped

  vault:
    build: ./services/vault
    container_name: origin-vault
    ports:
      - "8004:8000"
    environment:
      - VAULT_MASTER_KEY=${JWT_SECRET}
      - VAULT_DIR=/vault
      # Cursor API Integration
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      - CURSOR_WORKSPACE_ID=${CURSOR_WORKSPACE_ID:-}
    volumes:
      - vault-data:/vault
      - sentinel-alerts:/vault/sentinel/alerts:rw
      - codex-audit:/vault/codex/audit:rw
      # Cursor credentials storage
      - cursor-credentials:/vault/cursor:rw
    restart: unless-stopped

  orchestrator:
    build: ./services/orchestrator
    container_name: origin-orchestrator
    ports:
      - "8005:8000"
    environment:
      - MCP_HUB_URL=http://mcp-hub:8000
      - CODEX_URL=http://codex:8000
      - VAULT_URL=http://vault:8000
      - CAD_URL=http://cad:8000
      - UI_URL=http://ui:8000
      - MEMORY_URL=http://memory:8000
      - AUTO_CLAUDE_URL=http://auto-claude:8000
      - ORCHESTRATOR_DIR=/data/orchestrator
    volumes:
      - orchestrator-data:/data/orchestrator
    depends_on:
      - mcp-hub
      - vault
      - cad
      - auto-claude
    restart: unless-stopped

  backup:
    build: ./services/backup
    container_name: origin-backup
    ports:
      - "8006:8000"
    environment:
      - BACKUP_DIR=/backups
      - BACKUP_RETENTION_DAYS=30
      - BACKUP_SCHEDULE=daily
      - REMOTE_BACKUP_TYPE=${REMOTE_BACKUP_TYPE:-local}
      - B2_KEY_ID=${B2_KEY_ID:-}
      - B2_APP_KEY=${B2_APP_KEY:-}
      - B2_BUCKET_NAME=${B2_BUCKET_NAME:-}
      - DROPBOX_ACCESS_TOKEN=${DROPBOX_ACCESS_TOKEN:-}
      - DROPBOX_PATH=${DROPBOX_PATH:-/origin-os-backups}
      - GDRIVE_FOLDER_ID=${GDRIVE_FOLDER_ID:-}
      - RSYNC_DEST=${RSYNC_DEST:-}
      - EXTERNAL_BACKUP_PATH=${EXTERNAL_BACKUP_PATH:-}
      - S3_BACKUP_ENABLED=${S3_BACKUP_ENABLED:-false}
      - S3_BACKUP_BUCKET=${S3_BACKUP_BUCKET:-}
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID:-}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY:-}
      - AWS_REGION=${AWS_REGION:-}
    volumes:
      - backup-data:/backups
      - /var/run/docker.sock:/var/run/docker.sock
      - ${EXTERNAL_BACKUP_PATH:-/tmp/no-external}:/mnt/external:rw
    restart: unless-stopped

  memory:
    build: ./services/memory-s3
    container_name: origin-memory
    ports:
      - "8007:8000"
    environment:
      - EBS_DATA_DIR=/data/memory
      - EBS_MAX_SIZE_GB=100
      - EBS_COMPACT_TRIGGER_GB=85
      - EBS_TARGET_SIZE_GB=70
      - B2_ENABLED=${B2_ENABLED:-true}
      - B2_KEY_ID=${B2_KEY_ID}
      - B2_APP_KEY=${B2_APP_KEY}
      - B2_BUCKET_NAME=${B2_MEMORY_BUCKET:-origin-os-memory}
      - SYNC_INTERVAL_SECONDS=60
      - COMPACTION_CHECK_INTERVAL_SECONDS=300
      - COMPACTION_MIN_AGE_HOURS=24
      - COMPACTION_MIN_TURNS=10
      - LLM_API_URL=https://openrouter.ai/api/v1/chat/completions
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - LLM_SUMMARY_MODEL=anthropic/claude-3-haiku
      - EMBEDDING_API_URL=https://api.openai.com/v1/embeddings
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - EMBEDDING_MODEL=text-embedding-3-small
      - EMBEDDING_DIM=1536
    volumes:
      - memory-data:/data/memory
    restart: unless-stopped

  mcp-registry:
    build: ./services/mcp-registry
    container_name: origin-mcp-registry
    ports:
      - "8008:8000"
    volumes:
      - registry-data:/data/registry
    restart: unless-stopped

  sentinel:
    build: ./services/sentinel
    container_name: origin-sentinel
    environment:
      - S3_ENDPOINT=https://s3.us-west-004.backblazeb2.com
      - S3_KEY=${B2_KEY_ID}
      - S3_SECRET=${B2_APP_KEY}
      - BACKUP_BUCKET=origin-os-backups
      - CHECK_INTERVAL=3600
      - ALERT_OUTPUT_DIR=/vault/sentinel/alerts
    volumes:
      - sentinel-alerts:/vault/sentinel/alerts:rw
    depends_on:
      - vault
    restart: unless-stopped

  # ==========================================================================
  # AUTO-CLAUDE: Autonomous Multi-Session AI Coding Agent
  # Primary interface on port 8000
  # ==========================================================================
  auto-claude:
    build: ./services/auto-claude
    container_name: origin-auto-claude
    ports:
      - "8000:8000"
    environment:
      # =======================================================================
      # MODEL PROVIDER SELECTION
      # Set LLM_PROVIDER to: claude | openai | openrouter
      # =======================================================================
      - LLM_PROVIDER=${LLM_PROVIDER:-claude}
      
      # Claude/Anthropic (default)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-20250514}
      - CLAUDE_CODE_OAUTH_TOKEN=${CLAUDE_CODE_OAUTH_TOKEN:-}
      
      # OpenAI (GPT-4, GPT-4o, o1, o3)
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-4o}
      - OPENAI_ORG_ID=${OPENAI_ORG_ID:-}
      
      # OpenRouter (access to all models)
      - OPENROUTER_API_KEY=${OPENROUTER_API_KEY}
      - OPENROUTER_MODEL=${OPENROUTER_MODEL:-anthropic/claude-sonnet-4}
      
      # =======================================================================
      # MEMORY LAYER (FalkorDB + Graphiti)
      # =======================================================================
      - GRAPHITI_ENABLED=true
      - GRAPHITI_LLM_PROVIDER=${GRAPHITI_LLM_PROVIDER:-anthropic}
      - GRAPHITI_EMBEDDER_PROVIDER=${GRAPHITI_EMBEDDER_PROVIDER:-openai}
      - FALKORDB_URL=redis://falkordb:6379
      
      # =======================================================================
      # ORIGIN OS INTEGRATION (All MCPs)
      # =======================================================================
      - CODEX_URL=http://codex:8000
      - VAULT_URL=http://vault:8000
      - MEMORY_URL=http://memory:8000
      - MCP_HUB_URL=http://mcp-hub:8000
      - MCP_REGISTRY_URL=http://mcp-registry:8000
      - ORCHESTRATOR_URL=http://orchestrator:8000
      - CAD_URL=http://cad:8000
      
      # =======================================================================
      # CURSOR API INTEGRATION
      # =======================================================================
      - CURSOR_API_KEY=${CURSOR_API_KEY:-}
      - CURSOR_WORKSPACE_ID=${CURSOR_WORKSPACE_ID:-}
      - CURSOR_ENABLED=${CURSOR_ENABLED:-false}
      
      # =======================================================================
      # PROJECT & WORKSPACE
      # =======================================================================
      - AUTO_CLAUDE_DATA_DIR=/data/auto-claude
      - WORKTREE_DIR=/data/worktrees
      - SPECS_DIR=/data/specs
      - GITHUB_TOKEN=${GITHUB_TOKEN}
      - PROJECTS_DIR=/projects
      
      # =======================================================================
      # ADDITIONAL API KEYS
      # =======================================================================
      - GOOGLE_API_KEY=${GOOGLE_API_KEY:-}
      - FIRECRAWL_API_KEY=${FIRECRAWL_API_KEY:-}
      - SEMRUSH_API_KEY=${SEMRUSH_API_KEY:-}
      
    volumes:
      # Persistent data
      - auto-claude-data:/data/auto-claude
      - auto-claude-worktrees:/data/worktrees
      - auto-claude-specs:/data/specs
      # Project access
      - ${PROJECTS_DIR:-/Users/root1/projects}:/projects:rw
      # System state (read-only)
      - system-state:/system:ro
      # Memory integration
      - memory-data:/data/memory:ro
    depends_on:
      - codex
      - vault
      - memory
      - mcp-hub
      - mcp-registry
      - falkordb
    restart: unless-stopped

  # FalkorDB for Auto-Claude Memory Layer
  falkordb:
    image: falkordb/falkordb:latest
    container_name: origin-falkordb
    ports:
      - "6379:6379"
    volumes:
      - falkordb-data:/data
    restart: unless-stopped

  # ==========================================================================
  # CURSOR MCP: Cursor IDE Integration
  # ==========================================================================
  cursor-mcp:
    build: ./services/cursor-mcp
    container_name: origin-cursor-mcp
    ports:
      - "8010:8000"
    environment:
      - CURSOR_API_KEY=${CURSOR_API_KEY}
      - CURSOR_WORKSPACE_ID=${CURSOR_WORKSPACE_ID:-}
      - VAULT_URL=http://vault:8000
      - CODEX_URL=http://codex:8000
      - MCP_HUB_URL=http://mcp-hub:8000
      - AUTO_CLAUDE_URL=http://auto-claude:8000
    volumes:
      - cursor-data:/data/cursor
      - cursor-credentials:/vault/cursor:ro
    depends_on:
      - vault
      - codex
      - auto-claude
    restart: unless-stopped

volumes:
  mcp-data:
    name: origin-mcp-data
  cad-data:
    name: origin-cad-data
  vault-data:
    name: origin-vault-data
  orchestrator-data:
    name: origin-orchestrator-data
  backup-data:
    name: origin-backup-data
  memory-data:
    name: origin-memory-data
  registry-data:
    name: origin-registry-data
  # Security volumes
  sentinel-alerts:
    name: origin-sentinel-alerts
  codex-audit:
    name: origin-codex-audit
  codex-rules:
    name: origin-codex-rules
  system-state:
    name: origin-system-state
  # Auto-Claude volumes
  auto-claude-data:
    name: origin-auto-claude-data
  auto-claude-worktrees:
    name: origin-auto-claude-worktrees
  auto-claude-specs:
    name: origin-auto-claude-specs
  falkordb-data:
    name: origin-falkordb-data
  # Cursor volumes
  cursor-data:
    name: origin-cursor-data
  cursor-credentials:
    name: origin-cursor-credentials

networks:
  default:
    name: origin-network
