{
  "uid": "autonomic-ad-engine",
  "title": "Autonomic Ad-Engine – Surprise & Drift Control",
  "tags": ["lam", "bandit", "autonomic", "ads"],
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "10s",
  "panels": [

    {
      "id": 1,
      "type": "heatmap",
      "title": "Surprise Heatmap (LAM Prediction Error)",
      "description": "Distribution of surprise deltas. Centered on 0.0 = well-calibrated. Red zones indicate hallucination.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 8 },
      "targets": [
        {
          "expr": "sum(rate(lam_surprise_delta_bucket[5m])) by (le)",
          "format": "heatmap",
          "legendFormat": "surprise"
        }
      ],
      "options": {
        "color": {
          "mode": "spectrum",
          "scheme": "RdYlGn",
          "reverse": true
        },
        "yAxis": {
          "unit": "short",
          "min": -1,
          "max": 1
        }
      }
    },

    {
      "id": 2,
      "type": "timeseries",
      "title": "95th Percentile Surprise (Hallucination Detector)",
      "description": "p95 surprise delta. >0.3 = model becoming unreliable. >0.6 = critical failure mode.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 8, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(lam_surprise_delta_bucket[5m])) by (le))",
          "legendFormat": "p95 surprise"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.3 },
              { "color": "red", "value": 0.6 }
            ]
          }
        }
      }
    },

    {
      "id": 3,
      "type": "timeseries",
      "title": "Global Neural Drift Magnitude (EMA-Smoothed)",
      "description": "Centroid shift in latent space. >0.15 triggers FORCE_REEXPLORE. EMA α=0.2 prevents flapping.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 12, "y": 8, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "global_neural_drift_magnitude",
          "legendFormat": "drift ({{cluster_id}})"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.15 },
              { "color": "red", "value": 0.3 }
            ]
          }
        }
      }
    },

    {
      "id": 4,
      "type": "timeseries",
      "title": "Governor LoA Level by Vertical",
      "description": "Level of Autonomy: 1=Shadow, 2=Advisory, 3=Co-Pilot, 4=Governor",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 14, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "loa_current_level",
          "legendFormat": "{{vertical}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "min": 0,
          "max": 5,
          "thresholds": {
            "steps": [
              { "color": "blue", "value": null },
              { "color": "yellow", "value": 2 },
              { "color": "orange", "value": 3 },
              { "color": "green", "value": 4 }
            ]
          }
        }
      }
    },

    {
      "id": 5,
      "type": "timeseries",
      "title": "Container Tombstones by Reason",
      "description": "Container deaths by cause. High 'confident_failure' = model miscalibration.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 12, "y": 14, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "rate(container_tombstones_total[5m])",
          "legendFormat": "{{vertical}} - {{reason}}"
        }
      ]
    },

    {
      "id": 6,
      "type": "timeseries",
      "title": "Router Decision Latency (p95)",
      "description": "Decision latency by LoA level. >150ms triggers circuit breaker.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 20, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "histogram_quantile(0.95, sum(rate(router_decision_latency_seconds_bucket[5m])) by (le, loa_level))",
          "legendFormat": "p95 LoA {{loa_level}}"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 0.15 },
              { "color": "red", "value": 0.3 }
            ]
          }
        }
      }
    },

    {
      "id": 7,
      "type": "stat",
      "title": "Circuit Breaker Status",
      "description": "0 = CLOSED (healthy), >0 = failures accumulating",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 12, "y": 20, "w": 6, "h": 6 },
      "targets": [
        {
          "expr": "sum(circuit_breaker_trips_total)",
          "legendFormat": "trips"
        }
      ],
      "options": {
        "colorMode": "background",
        "graphMode": "none"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "orange", "value": 5 },
              { "color": "red", "value": 10 }
            ]
          }
        }
      }
    },

    {
      "id": 8,
      "type": "stat",
      "title": "FORCE_REEXPLORE Events",
      "description": "Total global re-exploration triggers",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 18, "y": 20, "w": 6, "h": 6 },
      "targets": [
        {
          "expr": "sum(force_reexplore_total)",
          "legendFormat": "reexplore"
        }
      ],
      "options": {
        "colorMode": "background"
      },
      "fieldConfig": {
        "defaults": {
          "thresholds": {
            "steps": [
              { "color": "green", "value": null },
              { "color": "yellow", "value": 1 },
              { "color": "orange", "value": 5 }
            ]
          }
        }
      }
    },

    {
      "id": 9,
      "type": "bargauge",
      "title": "LAM Offline Accuracy by Vertical",
      "description": "Counterfactual replay accuracy. <70% blocks LoA promotion.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 26, "w": 8, "h": 6 },
      "targets": [
        {
          "expr": "lam_offline_accuracy",
          "legendFormat": "{{vertical}}"
        }
      ],
      "options": {
        "displayMode": "gradient",
        "orientation": "horizontal"
      },
      "fieldConfig": {
        "defaults": {
          "unit": "percentunit",
          "min": 0,
          "max": 1,
          "thresholds": {
            "steps": [
              { "color": "red", "value": null },
              { "color": "yellow", "value": 0.7 },
              { "color": "green", "value": 0.85 }
            ]
          }
        }
      }
    },

    {
      "id": 10,
      "type": "timeseries",
      "title": "Thompson Sampling Arm Distribution",
      "description": "Traffic allocation per arm. Should be ~25% each initially.",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 8, "y": 26, "w": 8, "h": 6 },
      "targets": [
        {
          "expr": "bandit_arm_samples",
          "legendFormat": "{{site_id}} arm {{arm_index}}"
        }
      ]
    },

    {
      "id": 11,
      "type": "piechart",
      "title": "Surprise Zone Distribution",
      "description": "Calibrated (green) vs Critical Failures (red) vs Jackpots (blue)",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 16, "y": 26, "w": 8, "h": 6 },
      "targets": [
        {
          "expr": "sum(surprise_calibrated_total)",
          "legendFormat": "Calibrated [-0.1, 0.1]"
        },
        {
          "expr": "sum(surprise_critical_failures_total)",
          "legendFormat": "Critical Failures"
        },
        {
          "expr": "sum(surprise_exploration_jackpots_total)",
          "legendFormat": "Exploration Jackpots"
        }
      ],
      "options": {
        "pieType": "pie",
        "legend": {
          "displayMode": "table",
          "placement": "right"
        }
      }
    },

    {
      "id": 12,
      "type": "timeseries",
      "title": "Curriculum Training Progress",
      "description": "Current training stage (1-4) and loss by vertical",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 0, "y": 32, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "curriculum_stage_current",
          "legendFormat": "Stage {{vertical}}"
        },
        {
          "expr": "training_loss",
          "legendFormat": "Loss {{vertical}}"
        }
      ]
    },

    {
      "id": 13,
      "type": "timeseries",
      "title": "Dark Pattern Detections",
      "description": "Blocked mutations by pattern type",
      "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
      "gridPos": { "x": 12, "y": 32, "w": 12, "h": 6 },
      "targets": [
        {
          "expr": "rate(dark_pattern_detections_total[5m])",
          "legendFormat": "{{pattern_type}}"
        }
      ]
    }

  ],
  "templating": {
    "list": [
      {
        "name": "vertical",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
        "query": "label_values(lam_surprise_delta, vertical)",
        "includeAll": true,
        "multi": true
      },
      {
        "name": "site_id",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
        "query": "label_values(lam_surprise_delta, site_id)",
        "includeAll": true,
        "multi": true
      }
    ]
  },
  "annotations": {
    "list": [
      {
        "name": "FORCE_REEXPLORE Events",
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
        "expr": "increase(force_reexplore_total[1m]) > 0",
        "enable": true,
        "iconColor": "orange"
      },
      {
        "name": "LoA Upgrades",
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
        "expr": "increase(loa_upgrade_total[1m]) > 0",
        "enable": true,
        "iconColor": "green"
      },
      {
        "name": "Circuit Breaker Trips",
        "datasource": { "type": "prometheus", "uid": "PROMETHEUS_DS_UID" },
        "expr": "increase(circuit_breaker_trips_total[1m]) > 0",
        "enable": true,
        "iconColor": "red"
      }
    ]
  }
}
